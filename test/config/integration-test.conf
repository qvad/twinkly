# Integration test configuration for Twinkly
# Uses environment variables for database connections

proxy {
  listen-port = 5431
  
  postgresql {
    host = ${POSTGRES_HOST}
    port = ${POSTGRES_PORT}
    user = ${POSTGRES_USER}
    database = ${POSTGRES_DB}
    max-connections = 10
    connection-timeout = 10s
  }
  
  yugabytedb {
    host = ${YUGABYTE_HOST}
    port = ${YUGABYTE_PORT}
    user = ${YUGABYTE_USER}
    database = ${YUGABYTE_DB}
    max-connections = 10
    connection-timeout = 10s
  }
  
  routing {
    postgres-only-patterns = [
      "pg_.*",
      "information_schema.*"
    ]
    default-target = "dual"
  }
}

comparison {
  enabled = true
  require-secondary = true
  source-of-truth = "postgresql"  # Use PostgreSQL as source of truth for tests
  sort-before-compare = true
  max-compare-rows = 1000
  log-comparisons = true
  log-differences-only = false
  fail-on-differences = true
  
  # Enable slow query analysis for performance testing
  report-slow-queries = true
  slow-query-ratio = 2.0
  fail-on-slow-queries = false  # Don't fail tests on performance differences
  
  # Explain configuration
  explain {
    select = "EXPLAIN (ANALYZE, BUFFERS)"
    other  = "EXPLAIN"
  }
  
  # AI analysis disabled for integration tests
  ai {
    enabled = false
  }
  
  # Exclude time-sensitive queries from comparison
  exclude-patterns = [
    "SELECT.*now\\(\\).*",
    "SELECT.*current_timestamp.*",
    "SELECT.*CURRENT_TIMESTAMP.*"
  ]
}

# Monitoring and debugging
monitoring {
  log-errors = true
  log-error-mappings = true
  log-routing-decisions = true
}

debug {
  enabled = true
  log-all-queries = true
  log-protocol = false  # Disable to reduce test noise
  dump-network = false
}